---
name: Package tests

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  package-diff:
    name: Check package diffs
    runs-on: ubuntu-latest
    outputs:
      all_changed_files: ${{ steps.changed-packages.outputs.all_changed_files }}
      any_changed: ${{ steps.changed-packages.outputs.any_changed }}

    steps:
      - uses: actions/checkout@v3
      - name: Get changed package definitions
        id: changed-packages
        uses: tj-actions/changed-files@v34
        with:
          files: |
            packages/**/package.yaml

  tests:
    name: Test changed packages
    needs: package-diff
    if: ${{ needs.package-diff.outputs.any_changed == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        target:
          - linux_x64
          - linux_x64_gnu
          - linux_arm64
          - darwin_x64
          - darwin_arm64
          - win_x64
          - win_arm64

        include:
          - target: linux_x64
            runs-on: ubuntu-latest
          - target: linux_x64_gnu
            runs-on: ubuntu-latest
          - target: linux_arm64
            runs-on: ubuntu-latest
          - target: darwin_x64
            runs-on: macos-latest
          - target: darwin_arm64
            runs-on: macos-latest
          - target: win_x64
            runs-on: windows-latest
          - target: win_arm64
            runs-on: windows-latest

    runs-on: ${{ matrix.runs-on }}
    steps:
      - uses: actions/checkout@v3
      - uses: mason-org/actions/tests@v1
        with:
          packages: ${{ needs.package-diff.outputs.all_changed_files }}
          target: ${{ matrix.target }}
          log_level: DEBUG

  # This job is used for branch protection rule
  # Add this job to `Status checks that are required`
  status-check:
    name: Status check
    runs-on: ubuntu-latest
    needs: tests
    if: failure()
    steps:
      - run: exit 1
